<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: ruby | yasuoza diary]]></title>
  <link href="http://blog.yasuoza.com//categories/ruby/atom.xml" rel="self"/>
  <link href="http://blog.yasuoza.com/"/>
  <updated>2014-10-21T04:05:54+00:00</updated>
  <id>http://blog.yasuoza.com/</id>
  <author>
    <name><![CDATA[Yasuharu Ozaki]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Advanced ruby install via rbenv in OSX]]></title>
    <link href="http://blog.yasuoza.com/2014/01/28/advanced-ruby-install-via-rbenv-in-osx/"/>
    <updated>2014-01-28T04:25:51+00:00</updated>
    <id>http://blog.yasuoza.com/2014/01/28/advanced-ruby-install-via-rbenv-in-osx</id>
    <content type="html"><![CDATA[<p><strong>Parallel compile</strong></p>

<pre><code>$ MAKE_OPTS="-j 4" rbenv install 2.1.0
</code></pre>

<p>Above example compiles ruby with 4 workers.</p>

<p><strong>Readline support</strong></p>

<pre><code>$ brew install readline
$ RUBY_CONFIGURE_OPTS=--with-readline-dir=`brew --prefix readline` rbenv install 2.1.0
</code></pre>

<p>Mixed</p>

<pre><code>$ MAKE_OPTS="-j 4" RUBY_CONFIGURE_OPTS=--with-readline-dir=`brew --prefix readline` rbenv install 2.1.0
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sprockets with Padrino without plugin]]></title>
    <link href="http://blog.yasuoza.com/2013/04/06/sprockets-with-padrino-without-plugin/"/>
    <updated>2013-04-06T18:24:00+00:00</updated>
    <id>http://blog.yasuoza.com/2013/04/06/sprockets-with-padrino-without-plugin</id>
    <content type="html"><![CDATA[<p>One day I was searching to integrate <code>sprockets</code> to my padrino application, I found following article to make it.
<a href="http://arthurchiu.com/posts/20130328-sprockets_bower_padrino">Sprockets &amp; Bower in my Padrino please.</a>
In the article he explained to integrate sprockets to padrino using <a href="https://github.com/petebrowne/sprockets-helpers">sprockets-helpers</a>, through rack.</p>

<p>I was so excited because the content is what I wanted to do. But few hours after, I realized the way he explained works good for <code>development</code> and <code>production</code> environment, but not for <code>test</code> environment since in <code>test</code> environment,
<code>/assets</code> is not mounted to padrino itself. So, testing with javascript like <code>data-confirm</code> testing will fail because javascript(and other assets too) is not loaded!</p>

<p>I began to search how to mount(or insert) sprockets middleware in padrino applicaiton again and found the following way to solve the issue.</p>

<p>The difference found way and previous article way is just how to insert sprockets middleware.
So, <code>Gemfile</code>, <code>config/sprockets.rb</code> and <code>Rakefile</code> are same.
<code>app/app.rb</code> differs little bit, and <code>lib/sprockets_initializer.rb</code> will be newly created.</p>

<p><code>lib/sprockets_initializer.rb</code> is used to register to use <a href="https://github.com/sstephenson/sprockets/blob/master/lib/sprockets/server.rb">Sprockets::Server</a> for assets request handler.</p>

<pre><code class="ruby lib/sprockets_initializer.rb">module SprocketsInitializer
  def self.registered(app)
    # Make it lazy
    options[:asset_prefix] = -&gt; { Sprockets::Helpers.prefix }

    app.use ::SprocketsInitializer::Rack, options
  end

  class Rack
    def initialize(app, options={})
      @app = app
      @asset_prefix = options[:asset_prefix].call
    end

    def call(env)
      if env['PATH_INFO'].match(@asset_prefix)
        env['PATH_INFO'].gsub!(@asset_prefix, '')
        return PadrinoSprocekts.environment.call(env)
      end

      @app.call(env)
    end
  end
end
</code></pre>

<p>In <code>app/app.rb</code> register it only for not production environment because in production environment, I want to let application read assets from compiled assets path.</p>

<pre><code class="ruby app/app.rb">module Web
  class App &lt; Padrino::Application
    register Padrino::Rendering
    register Padrino::Mailer
    register Padrino::Helpers
    register SprocketsInitializer unless Padrino.env == :production
    helpers Sprockets::Helpers

  end
end
</code></pre>

<p>If you want, delete mounted sprockets from <code>config.ru</code></p>

<pre><code class="ruby config.ru">require File.expand_path("../config/boot.rb", __FILE__)

run Padrino.application
</code></pre>

<p>After changed configuration like above, you can test your application previous style.</p>

<pre><code class="plain">$ rake spec
</code></pre>

<p>Thank you for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[activemodel-attribute_changed_specification]]></title>
    <link href="http://blog.yasuoza.com/2012/12/19/activemodel-attribute-changed-specification-released/"/>
    <updated>2012-12-19T10:02:00+00:00</updated>
    <id>http://blog.yasuoza.com/2012/12/19/activemodel-attribute-changed-specification-released</id>
    <content type="html"><![CDATA[<p>On Dec 12, one feature suggestion posted to [Rails-core] ML.
The title was &ldquo;Active Record, changes from.. to..&rdquo;</p>

<p>His suggested feature was like following</p>

<pre><code class="ruby">class Book &lt; ActiveRecord::Base
  STATUS_DELIVER = [0, 1]
  before_save :send_mail_to_customer

  def send_mail_to_customer
   UserMailer.send_mail_to_customer if self.status.changes(from: 0, to: 1)
  end
end
</code></pre>

<p>I knew this can be done in <a href="http://api.rubyonrails.org/classes/ActiveModel/Dirty.html">ActiveModel::Dirty</a>, but the feature <code>from</code> and <code>to</code> was interesting. So I implemented into gem named <a href="https://github.com/YasuOza/activemodel-attribute_changed_specification">activemodel-attribute_changed_specification</a>.</p>

<p>You can use this gem like this</p>

<pre><code class="ruby">user = User.new
user.name = 'Bob'
user.name_changed?(from: nil,  to: 'Bob') # =&gt; true
user.name_changed?(from: 'Paul',  to: 'Bob') # =&gt; false
</code></pre>

<p>Though I overridden default <code>_changed?</code> method, I kept original <code>_changed?</code> method.</p>

<pre><code class="ruby">user = User.new
user.name = 'Bob'
user.name_changed? # =&gt; true
</code></pre>

<p>This is my first gem. Yeah, it&rsquo;s fun!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Blog update notificator]]></title>
    <link href="http://blog.yasuoza.com/2012/12/15/blog-update-notificator/"/>
    <updated>2012-12-15T16:22:00+00:00</updated>
    <id>http://blog.yasuoza.com/2012/12/15/blog-update-notificator</id>
    <content type="html"><![CDATA[<pre><code class="ruby">require 'feed-normalizer'
require 'twitter'

option = Hash[[ARGV]]

url = option['--url']

class FeedTweeter
  def initialize(arg = {url: nil})
    @url = arg[:url]
  end

  def site_updated?
    @feed = FeedNormalizer::FeedNormalizer.parse open(@url)
    @new_entry = @feed.entries.first

    return true unless File.exist? "#{current_file_dirpath}/#{remember_text_file}"

    last_tweeted_on = Time.parse(File.open(remember_text_file).read)
    last_tweeted_on &lt; @new_entry.last_updated
  end

  def tweet!
    tweet_text = make_tweet_text
    Twitter.update(tweet_text)

    remember_last_tweeted_on!
  end

  private
    def current_file_dirpath
      "#{File.expand_path('../',  __FILE__)}"
    end

    def remember_text_file
      'last_tweeted_on.txt';
    end

    def make_tweet_text
      blog_title = @feed.title
      new_entry_title = @new_entry.title
      new_entry_url = @new_entry.url
      "#{new_entry_title} - #{blog_title} #{new_entry_url}"
    end

    def remember_last_tweeted_on!
      File.open("#{current_file_dirpath}/#{remember_text_file}", 'w') do |file|
        file.write(@new_entry.last_updated)
      end
    end
end

Twitter.configure do |config|
  config.consumer_key = 'CONSUMER_KEY'
  config.consumer_secret = 'CONSUMER_SECRET'
  config.oauth_token = 'OAUTH_TOKEN'
  config.oauth_token_secret = 'OAUTH_TOKEN_SECRET'
end

feed_tweeter = FeedTweeter.new url: url
if feed_tweeter.site_updated?
  feed_tweeter.tweet!
end
</code></pre>

<p>This works with jenkins very well!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[No more rbenv rehash]]></title>
    <link href="http://blog.yasuoza.com/2012/12/06/no-more-rbenv-rehash/"/>
    <updated>2012-12-06T22:21:00+00:00</updated>
    <id>http://blog.yasuoza.com/2012/12/06/no-more-rbenv-rehash</id>
    <content type="html"><![CDATA[<p>I found nice gem named <a href="https://github.com/github/rbenv-autohash">rbenv-autohash</a></p>

<p>You do not need to type <code>rbenv rehash</code> anymore!</p>

<p>Yet you need to type <code>rbenv rehash</code> AFTER <code>gem install rbenv-autohash</code> :D</p>
]]></content>
  </entry>
  
</feed>
