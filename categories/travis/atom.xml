<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: travis | yasuoza diary]]></title>
  <link href="http://blog.yasuoza.com//categories/travis/atom.xml" rel="self"/>
  <link href="http://blog.yasuoza.com/"/>
  <updated>2014-07-24T07:05:49+00:00</updated>
  <id>http://blog.yasuoza.com/</id>
  <author>
    <name><![CDATA[Yasuharu Ozaki]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Octopress + GitHub Pages + Travis]]></title>
    <link href="http://blog.yasuoza.com/2014/01/13/octopress-plus-github-pages-plus-travis/"/>
    <updated>2014-01-13T06:57:31+00:00</updated>
    <id>http://blog.yasuoza.com/2014/01/13/octopress-plus-github-pages-plus-travis</id>
    <content type="html"><![CDATA[<p>Today I changed my blog generation CI from jenkins to Travis CI.</p>

<p>Following step shows how to make it. Suppose you are in project root.</p>

<p>First, install travis command from rubygems.</p>

<pre><code class="bash">$ gem install travis
</code></pre>

<p>Generate ssh-key accessible to only blog repository.</p>

<pre><code class="bash">$ ssh-keygen -t rsa -C 'youremail@examp.com' -f ~/.ssh/travis_rsa

# Copy public key to clipboard
$ cat ~/.ssh/travis_rsa.pub | pbcopy

# Set copied public key to deploy key in GitHub
$ open  https://github.com/_username_/_repository_/settings/keys
</code></pre>

<p>Then, setup <code>.travis.yml</code> like:</p>

<pre><code class="yaml">language: ruby
rvm:
- 2.1.0
branches:
  only:
  - master
before_script:
- git config --global user.name "_username_(via Travis CI)"
- git config --global user.email "youremail@gmail.com"
- git remote set-url origin $REPO.git
# array length 23 is calculated later as $RSA_LENGTH
- if [ -z "$id_rsa_{1..23}" ]; then echo 'No $id_rsa_{1..23} found !' ; exit 1; fi
- echo -n $id_rsa_{1..23} &gt;&gt; ~/.ssh/travis_rsa_64
- base64 --decode --ignore-garbage ~/.ssh/travis_rsa_64 &gt; ~/.ssh/id_rsa
- chmod 600 ~/.ssh/id_rsa
- echo -e "Host github.com\n\tStrictHostKeyChecking no\n" &gt;&gt; ~/.ssh/config
- bundle exec rake setup_github_pages[$REPO]
- git checkout -- _config.yml
script:
- bundle exec rake generate
after_script:
- bundle exec rake deploy
env:
  global:
  - REPO="git@github.com:_username_/_repository_"
</code></pre>

<p>Encrypt ssh-key via base64.</p>

<pre><code class="bash"># On a Mac, use this script to generate secure deployment key
$ base64 --break=0 ~/.ssh/travis_rsa &gt; ~/.ssh/travis_rsa_64

# If in linux
# base64 --wrap=0 ~/.ssh/travis_rsa &gt; ~/.ssh/travis_rsa_64

$ bash &lt;(cat ~/.ssh/travis_rsa_64 | perl -pe 's/(.{100})/$1\n/g' | nl | perl -pe 's/\s*(\d+)\s*(.*)/travis encrypt id_rsa_$1="$2" --add/')
</code></pre>

<p>Count <code>id_rsa_{1..$RSA_LENGTH}</code>.</p>

<pre><code class="bash">$ cat ~/.ssh/travis_rsa_64 | perl -pe 's/(.{100})/$1\n/g' | nl | tail
</code></pre>

<p>Finally, you should apply following patch to <code>rake deploy</code> to pulls from origin #{deploy_branch}.</p>

<pre><code class="diff">--- a/Rakefile
+++ b/Rakefile
@@ -248,8 +248,8 @@ desc "deploy public directory to github pages"
 multitask :push do
   puts "## Deploying branch to Github Pages "
   puts "## Pulling any updates from Github Pages "
-  cd "#{deploy_dir}" do
-    system "git pull"
+  cd "#{deploy_dir}" do
+    system "git pull origin #{deploy_branch}"
   end
   (Dir["#{deploy_dir}/*"]).each { |f| rm_rf(f) }
   Rake::Task[:copydot].invoke(public_dir, deploy_dir)
</code></pre>

<p>That&rsquo;s it. Connect blog repository to Travis CI, and commit change!</p>

<p>Refs:<br/>
- <a href="http://pchw.github.io/blog/2013/06/27/octopress-travis/  ">http://pchw.github.io/blog/2013/06/27/octopress-travis/  </a>
- <a href="http://www.harimenon.com/blog/2013/01/27/auto-deploying-to-my-octopress-blog/">http://www.harimenon.com/blog/2013/01/27/auto-deploying-to-my-octopress-blog/</a></p>
]]></content>
  </entry>
  
</feed>
